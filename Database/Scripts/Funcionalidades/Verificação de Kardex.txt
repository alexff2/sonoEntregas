CREATE VIEW VIEW_KARDEX_DIF_EST AS
SELECT A.CODIGO, A.NOME, SUM(B.QUANT_ENTRADA) ENT, SUM(B.QUANT_SAIDA) SAI, SUM(B.QUANT_ENTRADA) - SUM(B.QUANT_SAIDA) ESTOQUE, C.EST_ATUAL, (SUM(B.QUANT_ENTRADA) - SUM(B.QUANT_SAIDA)) - C.EST_ATUAL DIF
FROM PRODUTOS A
INNER JOIN VIEW_KARDEX_PRODUTOS B ON A.CODIGO = B.CODPRODUTO
INNER JOIN PRODLOJAS C ON A.CODIGO = C.CODIGO
WHERE C.CODLOJA = 1
AND B.LOJA = 1
GROUP BY A.CODIGO, A.NOME, C.EST_ATUAL