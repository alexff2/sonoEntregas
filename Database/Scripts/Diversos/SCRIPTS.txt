declare @IdSale int, @loja int
set @IdSale = 9433
set @loja = 5
--SELECT * FROM SALES WHERE ID_SALES = @IdSale
SELECT * FROM SALES WHERE CODLOJA = @loja AND ID_SALES = @IdSale
SELECT * FROM SALES_PROD WHERE CODLOJA = @loja AND ID_SALES = @IdSale
SELECT * FROM DELIVERYS_PROD WHERE CODLOJA = @loja AND ID_SALE = @IdSale
SELECT B.ALTERNATI, B.NOME, EST_ATUAL FROM SONO..PRODLOJAS A INNER JOIN SONO..PRODUTOS B ON A.CODIGO = B.CODIGO WHERE A.CODLOJA = 1 AND B.ALTERNATI IN (SELECT COD_ORIGINAL FROM DELIVERYS_PROD WHERE CODLOJA = @loja AND ID_SALE = @IdSale)
--update SALES set STATUS = 'Aberta' WHERE CODLOJA = @loja AND ID_SALES = @IdSale
--update SALES_PROD set STATUS = 'Enviado' WHERE CODLOJA = @loja AND ID_SALES = @IdSale
--update DELIVERYS_PROD set DELIVERED = 1, REASON_RETURN = 'A cliente ia passar o endereço correto' WHERE CODLOJA = @loja AND ID_SALE = @IdSale
--UPDATE SONO..PRODLOJAS SET EST_ATUAL = EST_ATUAL + 1, EST_LOJA = EST_LOJA + 1 FROM SONO..PRODLOJAS A INNER JOIN SONO..PRODUTOS B ON A.CODIGO = B.CODIGO WHERE A.CODLOJA = 1 AND B.ALTERNATI IN (SELECT COD_ORIGINAL FROM SALES_PROD WHERE CODLOJA = @loja AND ID_SALES = @IdSale)
--delete DELIVERYS_PROD WHERE CODLOJA = @loja AND ID_SALE = @IdSale
--UPDATE DELIVERYS_PROD SET DELIVERED = 1 WHERE CODLOJA = 2 AND ID_SALE = 128333 AND COD_ORIGINAL = '2880-6' AND ID_DELIVERY = 573

------------------------------------------------------
-- Mostrar estoque atual e estoque da contagem porém só dos itens negativos
SELECT B.ALTERNATI, B.NOME, B.ESTOQUE CONTAGEM, EST_ATUAL, C.QTD_DELIV, C.D_DELIVERING DATA_ENTREGA, A.ESTOQUE,
C.ID_DELIVERY NUM_ROTA, C.ID_SALE COD_VENDA
FROM SONO..VIEW_KARDEX_DIF_EST A
INNER JOIN BALANCO B ON A.ALTERNATI = B.ALTERNATI
INNER JOIN DELIVERYS_PROD C ON B.ALTERNATI = C.COD_ORIGINAL
WHERE A.EST_ATUAL < 0 --AND B.ALTERNATI = '655'
AND C.D_DELIVERING >= '2022-02-10'

-- Mostrar estoque atual e estoque da contagem
SELECT B.ALTERNATI, B.NOME, B.ESTOQUE CONTAGEM, A.EST_ATUAL, A.ESTOQUE
FROM SONO..VIEW_KARDEX_DIF_EST A
INNER JOIN BALANCO B ON A.ALTERNATI = B.ALTERNATI
WHERE B.ALTERNATI = '240'

-- Mostrando erros no Kardex/Estoque
SELECT * FROM SONO..VIEW_KARDEX_DIF_EST WHERE DIF <> 0

SELECT B.ALTERNATI, B.NOME, B.ESTOQUE CONTAGEM, EST_ATUAL, C.QTD_DELIV, C.D_DELIVERING DATA_ENTREGA, A.ESTOQUE,
C.ID_DELIVERY NUM_ROTA, C.ID_SALE COD_VENDA, C.DELIVERED
FROM SONO..VIEW_KARDEX_DIF_EST A
INNER JOIN BALANCO B ON A.ALTERNATI = B.ALTERNATI
INNER JOIN DELIVERYS_PROD C ON B.ALTERNATI = C.COD_ORIGINAL
WHERE B.ALTERNATI = '240'
AND C.D_DELIVERING >= '2022-02-10'

------------------------------------------
declare @idDeliv int
set @idDeliv = 1074

--SELECT * FROM DELIVERYS_PROD WHERE ID_DELIVERY = @idDeliv
--SELECT * FROM SALES_PROD A LEFT JOIN DELIVERYS_PROD B ON A.CODLOJA = B.CODLOJA AND A.ID_SALES = B.ID_SALE AND A.COD_ORIGINAL = B.COD_ORIGINAL WHERE B.ID_DELIVERY = @idDeliv
--SELECT * FROM SALES WHERE ID_SALES IN (SELECT ID_SALE FROM DELIVERYS_PROD WHERE ID_DELIVERY = @idDeliv) ORDER BY ID_SALES
--UPDATE DELIVERYS_PROD SET QTD_DELIV = QUANTIDADE FROM SALES_PROD A LEFT JOIN DELIVERYS_PROD B ON A.CODLOJA = B.CODLOJA AND A.ID_SALES = B.ID_SALE AND A.COD_ORIGINAL = B.COD_ORIGINAL WHERE B.ID_DELIVERY = @idDeliv
--UPDATE SALES_PROD SET STATUS = 'Em lançamento' FROM SALES_PROD A LEFT JOIN DELIVERYS_PROD B ON A.CODLOJA = B.CODLOJA AND A.ID_SALES = B.ID_SALE AND A.COD_ORIGINAL = B.COD_ORIGINAL WHERE B.ID_DELIVERY = @idDeliv
--UPDATE SALES SET STATUS = 'Fechada' WHERE ID_SALES IN (SELECT ID_SALE FROM DELIVERYS_PROD WHERE ID_DELIVERY = @idDeliv)

*-----------
SELECT A.ID_SALE CODIGO_VENDA, B.NOMECLI, Convert(varchar(10), B.EMISSAO,103) EMISSAO, Convert(varchar(10), A.D_DELIVERED,103) DATA_ENTREGA,
CASE WHEN DELIVERED = 0 THEN 'ENTREGA' ELSE 'RETORNO' END TIPO, A.ID_DELIVERY CODIGO_ENTREGA
FROM VIEW_COUNT_SALE_DELIV_PROD A 
INNER JOIN VIEW_SALES B ON A.ID_SALE = B.ID_SALES AND A.CODLOJA = B.CODLOJA
WHERE D_DELIVERED BETWEEN '2022-02-01' AND '2022-02-28' AND A.CODLOJA = 6
ORDER BY ID_SALE

--------------
SELECT A.*, STATUS FROM DELIVERYS_PROD A
INNER JOIN SALES_PROD B ON A.COD_ORIGINAL = B.COD_ORIGINAL AND A.CODLOJA = B.CODLOJA AND A.ID_SALE = B.ID_SALES
WHERE ID_DELIVERY = 1180


UPDATE SALES_PROD SET STATUS = 'Em lançamento'
FROM DELIVERYS_PROD A
INNER JOIN SALES_PROD B ON A.COD_ORIGINAL = B.COD_ORIGINAL AND A.CODLOJA = B.CODLOJA AND A.ID_SALE = B.ID_SALES
WHERE ID_DELIVERY = 1183


SELECT * FROM SALES WHERE ID_SALES IN (SELECT ID_SALE FROM DELIVERYS_PROD WHERE ID_DELIVERY = 1180)
ORDER BY ID_SALES


---- RETORNAR STATUS DELIV DE DESLOCAMENTO PARA EM LANÇAMENTO
declare @idDeliv int
set @idDeliv = 1285

SELECT B.NOME, A.EST_ATUAL, B.ALTERNATI, C.*
FROM SONO..PRODLOJAS A INNER JOIN SONO..PRODUTOS B ON A.CODIGO = B.CODIGO 
INNER JOIN (
	SELECT COD_ORIGINAL, SUM(QTD_DELIV) QTD
	FROM DELIVERYS_PROD 
	WHERE ID_DELIVERY = @idDeliv
	GROUP BY COD_ORIGINAL) C
ON B.ALTERNATI = C.COD_ORIGINAL
WHERE A.CODLOJA = 1 
ORDER BY B.ALTERNATI

SELECT A.*, STATUS FROM DELIVERYS_PROD A
INNER JOIN SALES_PROD B ON A.COD_ORIGINAL = B.COD_ORIGINAL AND A.CODLOJA = B.CODLOJA AND A.ID_SALE = B.ID_SALES
WHERE ID_DELIVERY = @idDeliv

UPDATE SONO..PRODLOJAS SET EST_ATUAL = EST_ATUAL + C.QTD, EST_LOJA = EST_LOJA + C.QTD
FROM SONO..PRODLOJAS A INNER JOIN SONO..PRODUTOS B ON A.CODIGO = B.CODIGO 
INNER JOIN (
	SELECT COD_ORIGINAL, SUM(QTD_DELIV) QTD
	FROM DELIVERYS_PROD 
	WHERE ID_DELIVERY = @idDeliv
	GROUP BY COD_ORIGINAL) C
ON B.ALTERNATI = C.COD_ORIGINAL
WHERE A.CODLOJA = 1 


UPDATE DELIVERYS_PROD SET D_DELIVERING = NULL WHERE ID_DELIVERY = @idDeliv

UPDATE SALES_PROD SET STATUS = 'Em lançamento' 
FROM SALES_PROD A LEFT JOIN DELIVERYS_PROD B ON A.CODLOJA = B.CODLOJA AND A.ID_SALES = B.ID_SALE AND A.COD_ORIGINAL = B.COD_ORIGINAL 
WHERE B.ID_DELIVERY = @idDeliv

UPDATE DELIVERYS SET STATUS = 'Em lançamento' WHERE ID = @idDeliv
--------------------- BALANÇO
SELECT A.ALTERNATI, B.EST_ATUAL, EST_LOJA, C.ESTOQUE
FROM PRODUTOS A
INNER JOIN PRODLOJAS B ON A.CODIGO = B.CODIGO
INNER JOIN SONOENTREGAS..BALANCO C ON A.ALTERNATI = C.ALTERNATI
WHERE B.CODLOJA = 1
AND A.ATIVO <> 'N'

--UPDATE PRODLOJAS SET EST_ATUAL = C.ESTOQUE, EST_LOJA = C.ESTOQUE
FROM PRODUTOS A
INNER JOIN PRODLOJAS B ON A.CODIGO = B.CODIGO
INNER JOIN SONOENTREGAS..BALANCO C ON A.ALTERNATI = C.ALTERNATI
WHERE B.CODLOJA = 1
AND A.ATIVO <> 'N'



