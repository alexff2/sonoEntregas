declare @iniEmiss datetime, @fimEmiss datetime
set @iniEmiss = '2022-05-01'
set @fimEmiss = '2022-05-31'
--Total
SELECT A.DESCRIPTION, COUNT(B.ID_SALE) QTD_VENDA FROM USERS A
INNER JOIN 
(SELECT A.ID_DELIVERY, A.ID_SALE, B.ID_DRIVER
FROM DELIVERYS_PROD A
INNER JOIN DELIVERYS B ON A.ID_DELIVERY = B.ID
LEFT JOIN SALES C ON A.ID_SALE = C.ID_SALES
WHERE A.D_DELIVERED BETWEEN @iniEmiss AND @fimEmiss
GROUP BY A.ID_DELIVERY, A.ID_SALE, B.ID_DRIVER) B ON A.ID = B.ID_DRIVER
GROUP BY A.DESCRIPTION
ORDER BY QTD_VENDA DESC
-- Retornos
SELECT A.DESCRIPTION, COUNT(B.ID_SALE) QTD_VENDA FROM USERS A
INNER JOIN 
(SELECT A.ID_DELIVERY, A.ID_SALE, B.ID_DRIVER
FROM DELIVERYS_PROD A
INNER JOIN DELIVERYS B ON A.ID_DELIVERY = B.ID
LEFT JOIN SALES C ON A.ID_SALE = C.ID_SALES
WHERE A.D_DELIVERED BETWEEN @iniEmiss AND @fimEmiss AND A.DELIVERED = 1
GROUP BY A.ID_DELIVERY, A.ID_SALE, B.ID_DRIVER) B ON A.ID = B.ID_DRIVER
GROUP BY A.DESCRIPTION
ORDER BY QTD_VENDA DESC
--Entregas
SELECT A.DESCRIPTION, COUNT(B.ID_SALE) QTD_VENDA FROM USERS A
INNER JOIN 
(SELECT A.ID_DELIVERY, A.ID_SALE, B.ID_DRIVER
FROM DELIVERYS_PROD A
INNER JOIN DELIVERYS B ON A.ID_DELIVERY = B.ID
LEFT JOIN SALES C ON A.ID_SALE = C.ID_SALES
WHERE A.D_DELIVERED BETWEEN @iniEmiss AND @fimEmiss AND A.DELIVERED = 0
GROUP BY A.ID_DELIVERY, A.ID_SALE, B.ID_DRIVER) B ON A.ID = B.ID_DRIVER
GROUP BY A.DESCRIPTION
ORDER BY QTD_VENDA DESC

------------------------------------ AJUDANTES-----------------------------------------
declare @iniEmiss datetime, @fimEmiss datetime
set @iniEmiss = '2022-05-01'
set @fimEmiss = '2022-05-31'
--Total
SELECT A.DESCRIPTION, COUNT(B.ID_SALE) QTD_VENDA FROM USERS A
RIGHT JOIN 
	(SELECT A.ID_DELIVERY, A.ID_SALE, B.ID_ASSISTANT
	FROM DELIVERYS_PROD A
	INNER JOIN DELIVERYS B ON A.ID_DELIVERY = B.ID
	LEFT JOIN SALES C ON A.ID_SALE = C.ID_SALES
	WHERE A.D_DELIVERED BETWEEN @iniEmiss AND @fimEmiss
	GROUP BY A.ID_DELIVERY, A.ID_SALE, B.ID_ASSISTANT) B ON A.ID = B.ID_ASSISTANT
GROUP BY A.DESCRIPTION
ORDER BY QTD_VENDA DESC
--Entregas
SELECT A.DESCRIPTION, COUNT(B.ID_SALE) QTD_VENDA FROM USERS A
INNER JOIN 
	(SELECT A.ID_DELIVERY, A.ID_SALE, B.ID_ASSISTANT
	FROM DELIVERYS_PROD A
	INNER JOIN DELIVERYS B ON A.ID_DELIVERY = B.ID
	LEFT JOIN SALES C ON A.ID_SALE = C.ID_SALES
	WHERE A.D_DELIVERED BETWEEN @iniEmiss AND @fimEmiss AND A.DELIVERED = 0
	GROUP BY A.ID_DELIVERY, A.ID_SALE, B.ID_ASSISTANT) B ON A.ID = B.ID_ASSISTANT
GROUP BY A.DESCRIPTION
ORDER BY QTD_VENDA DESC
--Retornos
SELECT A.DESCRIPTION, COUNT(B.ID_SALE) QTD_VENDA FROM USERS A
INNER JOIN 
	(SELECT A.ID_DELIVERY, A.ID_SALE, B.ID_ASSISTANT
	FROM DELIVERYS_PROD A
	INNER JOIN DELIVERYS B ON A.ID_DELIVERY = B.ID
	LEFT JOIN SALES C ON A.ID_SALE = C.ID_SALES
	WHERE A.D_DELIVERED BETWEEN @iniEmiss AND @fimEmiss AND A.DELIVERED = 1
	GROUP BY A.ID_DELIVERY, A.ID_SALE, B.ID_ASSISTANT) B ON A.ID = B.ID_ASSISTANT
GROUP BY A.DESCRIPTION
ORDER BY QTD_VENDA DESC